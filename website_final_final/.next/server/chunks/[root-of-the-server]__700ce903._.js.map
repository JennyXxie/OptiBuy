{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/gemini.ts"],"sourcesContent":["import { GoogleGenerativeAI } from '@google/generative-ai'\n\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '')\n\nexport async function generateGeminiResponse(prompt: string, context?: string): Promise<string> {\n  try {\n    // Check if API key is available\n    if (!process.env.GEMINI_API_KEY || process.env.GEMINI_API_KEY === 'Gemini_api') {\n      console.log('Using fallback response - Gemini API key not properly configured')\n      return generateFallbackResponse(prompt)\n    }\n\n    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' })\n    \n    const fullPrompt = context \n      ? `Context: ${context}\\n\\nUser Query: ${prompt}\\n\\nAs OptiBuy's AI shopping assistant, provide helpful, accurate responses about product recommendations, price comparisons, and shopping advice. Focus on Amazon, Temu, eBay, and Walmart.`\n      : `User Query: ${prompt}\\n\\nAs OptiBuy's AI shopping assistant, provide helpful, accurate responses about product recommendations, price comparisons, and shopping advice. Focus on Amazon, Temu, eBay, and Walmart.`\n\n    const result = await model.generateContent(fullPrompt)\n    const response = await result.response\n    return response.text()\n  } catch (error) {\n    console.error('Gemini API error:', error)\n    return generateFallbackResponse(prompt)\n  }\n}\n\nfunction generateFallbackResponse(prompt: string): string {\n  const lowerPrompt = prompt.toLowerCase()\n  \n  if (lowerPrompt.includes('laptop') || lowerPrompt.includes('computer')) {\n    return `I'd be happy to help you find laptop deals! 💻\\n\\n**🏆 TOP LAPTOP DEALS:**\\n\\n🥇 **MacBook Air M2 13\"**\\n   💵 Amazon: $1,199 | Temu: $1,099 (Save $100!)\\n   🔗 [View on Amazon →](https://amazon.com/search?k=macbook+air+m2)\\n   🔗 [View on Temu →](https://temu.com/search?q=macbook+air+m2)\\n\\n🥈 **Dell XPS 13**\\n   💵 Amazon: $999 | Shein: $899 (Save $100!)\\n   🔗 [View on Amazon →](https://amazon.com/search?k=dell+xps+13)\\n   🔗 [View on Shein →](https://shein.com/search?k=dell+xps+13)\\n\\n🥉 **Budget Gaming Laptop**\\n   💵 eBay: $599 (Refurbished) | Walmart: $649 (New)\\n   🔗 [View on eBay →](https://ebay.com/search?k=gaming+laptop)\\n   🔗 [View on Walmart →](https://walmart.com/search?q=gaming+laptop)\\n\\n**💡 My recommendation:** For the best value, check out Temu and eBay for significant savings. Would you like me to set up a price alert for any specific model?`\n  }\n  \n  if (lowerPrompt.includes('headphone') || lowerPrompt.includes('earphone')) {\n    return `Great choice! I found some excellent headphone deals! 🎧\\n\\n**🏆 TOP HEADPHONE DEALS:**\\n\\n🥇 **Wireless Bluetooth Headphones**\\n   💵 Temu: $45.99 (Save $44!) 🏆\\n   🔗 [View on Temu →](https://temu.com/search?q=wireless+bluetooth+headphones)\\n\\n🥈 **Premium Noise-Canceling**\\n   💵 Amazon: $89.99 | eBay: $52.99\\n   🔗 [View on Amazon →](https://amazon.com/search?k=noise+canceling+headphones)\\n   🔗 [View on eBay →](https://ebay.com/search?k=bluetooth+headphones)\\n\\n🥉 **Budget Options**\\n   💵 Walmart: $67.99\\n   🔗 [View on Walmart →](https://walmart.com/search?q=bluetooth+headphones)\\n\\n**Best Deal:** Temu has the lowest price at $45.99. There's also a 20% off coupon (TEMU20) that could save you even more!\\n\\nWould you like me to track this product or show you similar items?`\n  }\n  \n  if (lowerPrompt.includes('phone') || lowerPrompt.includes('smartphone')) {\n    return `I can help you find smartphone deals! 📱\\n\\n**🏆 TOP SMARTPHONE DEALS:**\\n\\n🥇 **iPhone 15**\\n   💵 Amazon: $799 | Temu: $749 (Save $50!)\\n   🔗 [View on Amazon →](https://amazon.com/search?k=iphone+15)\\n   🔗 [View on Temu →](https://temu.com/search?q=iphone+15)\\n\\n🥈 **Samsung Galaxy S24**\\n   💵 Amazon: $999 | eBay: $899 (Save $100!)\\n   🔗 [View on Amazon →](https://amazon.com/search?k=samsung+galaxy+s24)\\n   🔗 [View on eBay →](https://ebay.com/search?k=samsung+galaxy+s24)\\n\\n🥉 **Google Pixel 8**\\n   💵 Walmart: $699 | Temu: $649 (Save $50!)\\n   🔗 [View on Walmart →](https://walmart.com/search?q=google+pixel+8)\\n   🔗 [View on Temu →](https://temu.com/search?q=google+pixel+8)\\n\\n**💡 My recommendation:** Check eBay for refurbished models with warranties, or Temu for new devices at lower prices. Would you like me to set up a price alert for a specific phone?`\n  }\n  \n  if (lowerPrompt.includes('deal') || lowerPrompt.includes('cheap') || lowerPrompt.includes('budget')) {\n    return `I love helping you save money! 💰\\n\\n**🔥 TODAY'S TOP DEALS:**\\n\\n🥇 **Electronics** - Up to 50% off\\n   🔗 [Shop Temu Electronics →](https://temu.com/category/electronics.html)\\n\\n🥈 **Fashion** - 30% off with code SHEIN30\\n   🔗 [Shop Shein Fashion →](https://shein.com/category/women.html)\\n\\n🥉 **Home Goods** - Prime deals ending soon\\n   🔗 [Shop Amazon Home →](https://amazon.com/gp/goldbox)\\n\\n💰 **Gaming** - Auctions starting at $1\\n   🔗 [Shop eBay Gaming →](https://ebay.com/b/Video-Games/139973)\\n\\n**🏆 Best Platform Guide:**\\n• **Temu**: Electronics & gadgets (lowest prices)\\n• **eBay**: Auctions & refurbished items\\n• **Walmart**: Reliable shipping & returns\\n• **Amazon**: Prime benefits & fast delivery\\n\\nWhat category interests you most?`\n  }\n  \n  return `I understand you're looking for: \"${prompt}\"\\n\\nI'm here to help you find the best deals! I can:\\n• Compare prices across Amazon, Temu, eBay, and Walmart\\n• Track price history and predict drops\\n• Find active coupons and discounts\\n• Give personalized recommendations\\n\\nTry asking me about specific products like \"wireless headphones\" or \"laptop deals\" and I'll show you the best options!`\n}\n\nexport async function generateProductAnalysis(products: Array<{name: string, price: number, platform: string, rating?: number, reviews?: number, url?: string, image?: string, extracted_price?: number, source?: string, reviews_count?: number, image_url?: string, thumbnail?: string}>, userQuery: string, dataSource?: string): Promise<string> {\n  try {\n    // Check if API key is available\n    if (!process.env.GEMINI_API_KEY || process.env.GEMINI_API_KEY === 'Gemini_api') {\n      console.log('Using fallback product analysis')\n      return generateFallbackProductAnalysis(products, userQuery, dataSource)\n    }\n\n    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-pro' })\n    \n    const productData = products.map(p => ({\n      name: p.name,\n      price: p.extracted_price || p.price,\n      platform: p.platform || p.source,\n      rating: p.rating,\n      reviews: p.reviews || p.reviews_count,\n      url: p.url,\n      image: p.image || p.image_url || p.thumbnail\n    }))\n\n    const dataSourceInfo = dataSource === 'local' ? 'local database' : \n                          dataSource === 'live' ? 'live e-commerce data' : \n                          dataSource === 'local+live' ? 'local database + live e-commerce data' : \n                          'product database'\n\n    const prompt = `\n    You are an AI agent that compares local product data with live e-commerce offers.\n    \n    User Query: \"${userQuery}\"\n    Data Source: ${dataSourceInfo}\n    \n    Products Found:\n    ${JSON.stringify(productData, null, 2)}\n    \n    As an AI shopping assistant, provide a comprehensive analysis including:\n    1. Best value recommendations (ranked by price, rating, and availability)\n    2. Price comparisons across platforms\n    3. Quality indicators (ratings, reviews count)\n    4. Platform-specific advantages (Amazon, Walmart, eBay, etc.)\n    5. Data freshness note (local vs live data)\n    6. Overall recommendation with clear reasoning\n    7. Money-saving tips and alternatives\n    \n    Be concise but informative, and focus on helping the user make the best purchase decision.\n    Format your response with clear sections and emojis for better readability.\n    `\n\n    const result = await model.generateContent(prompt)\n    const response = await result.response\n    return response.text()\n  } catch (error) {\n    console.error('Gemini product analysis error:', error)\n    return generateFallbackProductAnalysis(products, userQuery, dataSource)\n  }\n}\n\nfunction generateFallbackProductAnalysis(products: Array<{name: string, price: number, platform: string, rating?: number, reviews?: number, url?: string, image?: string, extracted_price?: number, source?: string, reviews_count?: number, image_url?: string, thumbnail?: string}>, userQuery: string, dataSource?: string): string {\n  if (products.length === 0) {\n    return `I couldn't find specific products for \"${userQuery}\" right now, but I can help you search across different platforms. Try asking about specific products like \"wireless headphones\" or \"laptop deals\" and I'll show you the best options!`\n  }\n\n  const bestPrice = Math.min(...products.map(p => p.extracted_price || p.price))\n  const bestProduct = products.find(p => (p.extracted_price || p.price) === bestPrice)\n  const platforms = [...new Set(products.map(p => p.platform || p.source))]\n  \n  // Sort products by price for better presentation\n  const sortedProducts = products.sort((a, b) => (a.extracted_price || a.price) - (b.extracted_price || b.price))\n  const topProducts = sortedProducts.slice(0, 8) // Show top 8 deals\n\n  const dataSourceInfo = dataSource === 'local' ? 'local database' : \n                        dataSource === 'live' ? 'live e-commerce data' : \n                        dataSource === 'local+live' ? 'local database + live e-commerce data' : \n                        'product database'\n\n  let response = `I found ${products.length} products for \"${userQuery}\"! 🎯\\n`\n  response += `📊 Data Source: ${dataSourceInfo}\\n\\n`\n  response += `**🏆 TOP DEALS (Ranked by Price, Rating & Reviews):**\\n\\n`\n  \n  topProducts.forEach((product, index) => {\n    const emoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '💰'\n    const price = product.extracted_price || product.price\n    const platform = product.platform || product.source\n    const rating = product.rating || 0\n    const reviews = product.reviews || product.reviews_count || 0\n    \n    response += `${emoji} **${product.name}**\\n`\n    response += `   💵 $${price} on ${platform}\\n`\n    if (rating > 0) response += `   ⭐ ${rating}/5 (${reviews} reviews)\\n`\n    response += `   🔗 [View Product →](${product.url})\\n\\n`\n  })\n\n  response += `**📊 Summary:**\\n`\n  response += `• Available on: ${platforms.join(', ')}\\n`\n  response += `• Price Range: $${Math.min(...products.map(p => p.extracted_price || p.price))} - $${Math.max(...products.map(p => p.extracted_price || p.price))}\\n`\n  response += `• Best Deal: ${bestProduct?.platform || bestProduct?.source} at $${bestProduct?.extracted_price || bestProduct?.price}\\n`\n  response += `• Data Freshness: ${dataSourceInfo}\\n\\n`\n  \n  response += `**💡 My Recommendation:** ${bestProduct?.platform || bestProduct?.source} has the best price at $${bestProduct?.extracted_price || bestProduct?.price}. `\n  if (bestProduct?.platform?.toLowerCase().includes('temu') || bestProduct?.source?.toLowerCase().includes('temu')) {\n    response += 'Temu often has the lowest prices but check shipping times.'\n  } else if (bestProduct?.platform?.toLowerCase().includes('ebay') || bestProduct?.source?.toLowerCase().includes('ebay')) {\n    response += 'eBay is great for deals, especially refurbished items.'\n  } else if (bestProduct?.platform?.toLowerCase().includes('amazon') || bestProduct?.source?.toLowerCase().includes('amazon')) {\n    response += 'Amazon offers reliable shipping and easy returns.'\n  } else {\n    response += 'This is a solid choice with good value.'\n  }\n  \n  response += `\\n\\n**🎯 Quick Actions:**\\n`\n  response += `• Click any \"View Product →\" link above to shop directly\\n`\n  response += `• Ask me to set up price alerts for any product\\n`\n  response += `• Request similar products or specific brands\\n`\n  response += `• Compare with other platforms for better deals`\n\n  return response\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,QAAQ,IAAI,uNAAkB,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI;AAE5D,eAAe,uBAAuB,MAAc,EAAE,OAAgB;IAC3E,IAAI;QACF,gCAAgC;QAChC,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI,QAAQ,GAAG,CAAC,cAAc,KAAK,cAAc;YAC9E,QAAQ,GAAG,CAAC;YACZ,OAAO,yBAAyB;QAClC;QAEA,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YAAE,OAAO;QAAiB;QAEjE,MAAM,aAAa,UACf,CAAC,SAAS,EAAE,QAAQ,gBAAgB,EAAE,OAAO,4LAA4L,CAAC,GAC1O,CAAC,YAAY,EAAE,OAAO,4LAA4L,CAAC;QAEvN,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;QAC3C,MAAM,WAAW,MAAM,OAAO,QAAQ;QACtC,OAAO,SAAS,IAAI;IACtB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,yBAAyB;IAClC;AACF;AAEA,SAAS,yBAAyB,MAAc;IAC9C,MAAM,cAAc,OAAO,WAAW;IAEtC,IAAI,YAAY,QAAQ,CAAC,aAAa,YAAY,QAAQ,CAAC,aAAa;QACtE,OAAO,CAAC,22BAA22B,CAAC;IACt3B;IAEA,IAAI,YAAY,QAAQ,CAAC,gBAAgB,YAAY,QAAQ,CAAC,aAAa;QACzE,OAAO,CAAC,qxBAAqxB,CAAC;IAChyB;IAEA,IAAI,YAAY,QAAQ,CAAC,YAAY,YAAY,QAAQ,CAAC,eAAe;QACvE,OAAO,CAAC,42BAA42B,CAAC;IACv3B;IAEA,IAAI,YAAY,QAAQ,CAAC,WAAW,YAAY,QAAQ,CAAC,YAAY,YAAY,QAAQ,CAAC,WAAW;QACnG,OAAO,CAAC,uvBAAuvB,CAAC;IAClwB;IAEA,OAAO,CAAC,kCAAkC,EAAE,OAAO,2VAA2V,CAAC;AACjZ;AAEO,eAAe,wBAAwB,QAA4O,EAAE,SAAiB,EAAE,UAAmB;IAChU,IAAI;QACF,gCAAgC;QAChC,IAAI,CAAC,QAAQ,GAAG,CAAC,cAAc,IAAI,QAAQ,GAAG,CAAC,cAAc,KAAK,cAAc;YAC9E,QAAQ,GAAG,CAAC;YACZ,OAAO,gCAAgC,UAAU,WAAW;QAC9D;QAEA,MAAM,QAAQ,MAAM,kBAAkB,CAAC;YAAE,OAAO;QAAiB;QAEjE,MAAM,cAAc,SAAS,GAAG,CAAC,CAAA,IAAK,CAAC;gBACrC,MAAM,EAAE,IAAI;gBACZ,OAAO,EAAE,eAAe,IAAI,EAAE,KAAK;gBACnC,UAAU,EAAE,QAAQ,IAAI,EAAE,MAAM;gBAChC,QAAQ,EAAE,MAAM;gBAChB,SAAS,EAAE,OAAO,IAAI,EAAE,aAAa;gBACrC,KAAK,EAAE,GAAG;gBACV,OAAO,EAAE,KAAK,IAAI,EAAE,SAAS,IAAI,EAAE,SAAS;YAC9C,CAAC;QAED,MAAM,iBAAiB,eAAe,UAAU,mBAC1B,eAAe,SAAS,yBACxB,eAAe,eAAe,0CAC9B;QAEtB,MAAM,SAAS,CAAC;;;iBAGH,EAAE,UAAU;iBACZ,EAAE,eAAe;;;IAG9B,EAAE,KAAK,SAAS,CAAC,aAAa,MAAM,GAAG;;;;;;;;;;;;;IAavC,CAAC;QAED,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;QAC3C,MAAM,WAAW,MAAM,OAAO,QAAQ;QACtC,OAAO,SAAS,IAAI;IACtB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,gCAAgC,UAAU,WAAW;IAC9D;AACF;AAEA,SAAS,gCAAgC,QAA4O,EAAE,SAAiB,EAAE,UAAmB;IAC3T,IAAI,SAAS,MAAM,KAAK,GAAG;QACzB,OAAO,CAAC,uCAAuC,EAAE,UAAU,sLAAsL,CAAC;IACpP;IAEA,MAAM,YAAY,KAAK,GAAG,IAAI,SAAS,GAAG,CAAC,CAAA,IAAK,EAAE,eAAe,IAAI,EAAE,KAAK;IAC5E,MAAM,cAAc,SAAS,IAAI,CAAC,CAAA,IAAK,CAAC,EAAE,eAAe,IAAI,EAAE,KAAK,MAAM;IAC1E,MAAM,YAAY;WAAI,IAAI,IAAI,SAAS,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,IAAI,EAAE,MAAM;KAAG;IAEzE,iDAAiD;IACjD,MAAM,iBAAiB,SAAS,IAAI,CAAC,CAAC,GAAG,IAAM,CAAC,EAAE,eAAe,IAAI,EAAE,KAAK,IAAI,CAAC,EAAE,eAAe,IAAI,EAAE,KAAK;IAC7G,MAAM,cAAc,eAAe,KAAK,CAAC,GAAG,GAAG,mBAAmB;;IAElE,MAAM,iBAAiB,eAAe,UAAU,mBAC1B,eAAe,SAAS,yBACxB,eAAe,eAAe,0CAC9B;IAEtB,IAAI,WAAW,CAAC,QAAQ,EAAE,SAAS,MAAM,CAAC,eAAe,EAAE,UAAU,OAAO,CAAC;IAC7E,YAAY,CAAC,gBAAgB,EAAE,eAAe,IAAI,CAAC;IACnD,YAAY,CAAC,yDAAyD,CAAC;IAEvE,YAAY,OAAO,CAAC,CAAC,SAAS;QAC5B,MAAM,QAAQ,UAAU,IAAI,OAAO,UAAU,IAAI,OAAO,UAAU,IAAI,OAAO;QAC7E,MAAM,QAAQ,QAAQ,eAAe,IAAI,QAAQ,KAAK;QACtD,MAAM,WAAW,QAAQ,QAAQ,IAAI,QAAQ,MAAM;QACnD,MAAM,SAAS,QAAQ,MAAM,IAAI;QACjC,MAAM,UAAU,QAAQ,OAAO,IAAI,QAAQ,aAAa,IAAI;QAE5D,YAAY,GAAG,MAAM,GAAG,EAAE,QAAQ,IAAI,CAAC,IAAI,CAAC;QAC5C,YAAY,CAAC,OAAO,EAAE,MAAM,IAAI,EAAE,SAAS,EAAE,CAAC;QAC9C,IAAI,SAAS,GAAG,YAAY,CAAC,KAAK,EAAE,OAAO,IAAI,EAAE,QAAQ,WAAW,CAAC;QACrE,YAAY,CAAC,uBAAuB,EAAE,QAAQ,GAAG,CAAC,KAAK,CAAC;IAC1D;IAEA,YAAY,CAAC,iBAAiB,CAAC;IAC/B,YAAY,CAAC,gBAAgB,EAAE,UAAU,IAAI,CAAC,MAAM,EAAE,CAAC;IACvD,YAAY,CAAC,gBAAgB,EAAE,KAAK,GAAG,IAAI,SAAS,GAAG,CAAC,CAAA,IAAK,EAAE,eAAe,IAAI,EAAE,KAAK,GAAG,IAAI,EAAE,KAAK,GAAG,IAAI,SAAS,GAAG,CAAC,CAAA,IAAK,EAAE,eAAe,IAAI,EAAE,KAAK,GAAG,EAAE,CAAC;IAClK,YAAY,CAAC,aAAa,EAAE,aAAa,YAAY,aAAa,OAAO,KAAK,EAAE,aAAa,mBAAmB,aAAa,MAAM,EAAE,CAAC;IACtI,YAAY,CAAC,kBAAkB,EAAE,eAAe,IAAI,CAAC;IAErD,YAAY,CAAC,0BAA0B,EAAE,aAAa,YAAY,aAAa,OAAO,wBAAwB,EAAE,aAAa,mBAAmB,aAAa,MAAM,EAAE,CAAC;IACtK,IAAI,aAAa,UAAU,cAAc,SAAS,WAAW,aAAa,QAAQ,cAAc,SAAS,SAAS;QAChH,YAAY;IACd,OAAO,IAAI,aAAa,UAAU,cAAc,SAAS,WAAW,aAAa,QAAQ,cAAc,SAAS,SAAS;QACvH,YAAY;IACd,OAAO,IAAI,aAAa,UAAU,cAAc,SAAS,aAAa,aAAa,QAAQ,cAAc,SAAS,WAAW;QAC3H,YAAY;IACd,OAAO;QACL,YAAY;IACd;IAEA,YAAY,CAAC,2BAA2B,CAAC;IACzC,YAAY,CAAC,0DAA0D,CAAC;IACxE,YAAY,CAAC,iDAAiD,CAAC;IAC/D,YAAY,CAAC,+CAA+C,CAAC;IAC7D,YAAY,CAAC,+CAA+C,CAAC;IAE7D,OAAO;AACT","debugId":null}},
    {"offset": {"line": 299, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/serpapi.ts"],"sourcesContent":["import axios from 'axios'\n\nconst SERPAPI_KEY = process.env.SERPAPI_KEY\n\nif (!SERPAPI_KEY) {\n  console.warn('⚠️ Missing SERPAPI_KEY in environment variables')\n}\n\nexport interface SerpApiProduct {\n  title: string\n  price: string\n  extracted_price: number\n  link: string\n  source: string\n  rating?: number\n  reviews?: number\n  thumbnail?: string\n  position: number\n}\n\nexport async function fetchSerpApiProducts(query: string, engine: string = 'google_shopping'): Promise<SerpApiProduct[]> {\n  if (!SERPAPI_KEY) {\n    console.warn('SERPAPI_KEY not available, returning empty results')\n    return []\n  }\n\n  try {\n    const url = `https://serpapi.com/search.json?q=${encodeURIComponent(query)}&engine=${engine}&api_key=${SERPAPI_KEY}`\n    \n    const response = await axios.get(url, {\n      timeout: 10000,\n    })\n\n    const results = response.data.shopping_results || response.data.organic_results || []\n    \n    return results.map((item: any) => ({\n      title: item.title || '',\n      price: item.price || '',\n      extracted_price: item.extracted_price || 0,\n      link: item.link || item.product_link || '',\n      source: item.source || 'Unknown',\n      rating: item.rating || undefined,\n      reviews: item.reviews || undefined,\n      thumbnail: item.thumbnail || '',\n      position: item.position || 0\n    }))\n  } catch (error) {\n    console.error('SerpAPI error:', error)\n    return []\n  }\n}\n\nexport async function fetchAmazonProducts(query: string): Promise<SerpApiProduct[]> {\n  return fetchSerpApiProducts(query, 'amazon')\n}\n\nexport async function fetchGoogleShoppingProducts(query: string): Promise<SerpApiProduct[]> {\n  return fetchSerpApiProducts(query, 'google_shopping')\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;AAE3C,IAAI,CAAC,aAAa;IAChB,QAAQ,IAAI,CAAC;AACf;AAcO,eAAe,qBAAqB,KAAa,EAAE,SAAiB,iBAAiB;IAC1F,IAAI,CAAC,aAAa;QAChB,QAAQ,IAAI,CAAC;QACb,OAAO,EAAE;IACX;IAEA,IAAI;QACF,MAAM,MAAM,CAAC,kCAAkC,EAAE,mBAAmB,OAAO,QAAQ,EAAE,OAAO,SAAS,EAAE,aAAa;QAEpH,MAAM,WAAW,MAAM,mLAAK,CAAC,GAAG,CAAC,KAAK;YACpC,SAAS;QACX;QAEA,MAAM,UAAU,SAAS,IAAI,CAAC,gBAAgB,IAAI,SAAS,IAAI,CAAC,eAAe,IAAI,EAAE;QAErF,OAAO,QAAQ,GAAG,CAAC,CAAC,OAAc,CAAC;gBACjC,OAAO,KAAK,KAAK,IAAI;gBACrB,OAAO,KAAK,KAAK,IAAI;gBACrB,iBAAiB,KAAK,eAAe,IAAI;gBACzC,MAAM,KAAK,IAAI,IAAI,KAAK,YAAY,IAAI;gBACxC,QAAQ,KAAK,MAAM,IAAI;gBACvB,QAAQ,KAAK,MAAM,IAAI;gBACvB,SAAS,KAAK,OAAO,IAAI;gBACzB,WAAW,KAAK,SAAS,IAAI;gBAC7B,UAAU,KAAK,QAAQ,IAAI;YAC7B,CAAC;IACH,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,EAAE;IACX;AACF;AAEO,eAAe,oBAAoB,KAAa;IACrD,OAAO,qBAAqB,OAAO;AACrC;AAEO,eAAe,4BAA4B,KAAa;IAC7D,OAAO,qBAAqB,OAAO;AACrC","debugId":null}},
    {"offset": {"line": 350, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/csv-parser.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\n\nexport interface CSVProduct {\n  id: string\n  name: string\n  category: string\n  brand: string\n  price: number\n  rating: number\n  reviews_count: number\n  source: string\n  url: string\n  description: string\n  image_url: string\n  date_added: string\n  extracted_price: number\n  reviews: string\n  thumbnail: string\n  serpapi_product_api: string\n}\n\nexport function parseCSVProducts(): CSVProduct[] {\n  try {\n    const csvPath = path.join(process.cwd(), 'products_rows.csv')\n    const csvContent = fs.readFileSync(csvPath, 'utf-8')\n    \n    const lines = csvContent.split('\\n').filter(line => line.trim())\n    const headers = lines[0].split(',').map(header => header.replace(/\"/g, '').trim())\n    \n    const products: CSVProduct[] = []\n    \n    for (let i = 1; i < lines.length; i++) {\n      const values = parseCSVLine(lines[i])\n      \n      if (values.length >= headers.length) {\n        const product: CSVProduct = {\n          id: values[0] || '',\n          name: values[1] || '',\n          category: values[2] || '',\n          brand: values[3] || '',\n          price: parseFloat(values[4]) || 0,\n          rating: parseFloat(values[5]) || 0,\n          reviews_count: parseInt(values[6]) || 0,\n          source: values[7] || '',\n          url: values[8] || '',\n          description: values[9] || '',\n          image_url: values[10] || '',\n          date_added: values[11] || '',\n          extracted_price: parseFloat(values[12]) || 0,\n          reviews: values[13] || '',\n          thumbnail: values[14] || '',\n          serpapi_product_api: values[15] || ''\n        }\n        products.push(product)\n      }\n    }\n    \n    console.log(`📊 Loaded ${products.length} products from CSV`)\n    return products\n  } catch (error) {\n    console.error('❌ Error parsing CSV:', error)\n    return []\n  }\n}\n\nfunction parseCSVLine(line: string): string[] {\n  const result: string[] = []\n  let current = ''\n  let inQuotes = false\n  \n  for (let i = 0; i < line.length; i++) {\n    const char = line[i]\n    \n    if (char === '\"') {\n      inQuotes = !inQuotes\n    } else if (char === ',' && !inQuotes) {\n      result.push(current.trim())\n      current = ''\n    } else {\n      current += char\n    }\n  }\n  \n  result.push(current.trim())\n  return result\n}\n\nexport function searchCSVProducts(query: string, products: CSVProduct[]): CSVProduct[] {\n  const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 2)\n  \n  return products.filter(product => {\n    const searchableText = [\n      product.name,\n      product.category,\n      product.brand,\n      product.description\n    ].join(' ').toLowerCase()\n    \n    return searchTerms.some(term => searchableText.includes(term))\n  })\n}\n\nexport function rankProducts(products: CSVProduct[]): CSVProduct[] {\n  return products.sort((a, b) => {\n    // Primary sort: by price (ascending - cheaper first)\n    const priceA = a.extracted_price || a.price || 0\n    const priceB = b.extracted_price || b.price || 0\n    \n    if (priceA !== priceB) {\n      return priceA - priceB\n    }\n    \n    // Secondary sort: by rating (descending - higher rating first)\n    const ratingA = a.rating || 0\n    const ratingB = b.rating || 0\n    \n    if (ratingA !== ratingB) {\n      return ratingB - ratingA\n    }\n    \n    // Tertiary sort: by reviews count (descending - more reviews first)\n    const reviewsA = a.reviews_count || 0\n    const reviewsB = b.reviews_count || 0\n    \n    return reviewsB - reviewsA\n  })\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 460, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.REACT_APP_SUPABASE_URL\nconst SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.REACT_APP_SUPABASE_KEY\n\nif (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n  console.warn('⚠️ Missing Supabase environment variables')\n}\n\nexport const supabase = createClient(SUPABASE_URL || '', SUPABASE_ANON_KEY || '')\n\nexport interface SupabaseProduct {\n  id?: string\n  name: string\n  category: string\n  brand: string\n  price: number\n  rating: number\n  reviews_count: number\n  source: string\n  url: string\n  description: string\n  image_url: string\n  date_added: string\n  extracted_price: number\n  reviews: string\n  thumbnail: string\n  serpapi_product_api: string\n}\n\nexport async function insertProductsToSupabase(products: SupabaseProduct[]): Promise<boolean> {\n  try {\n    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n      console.warn('⚠️ Supabase not configured, skipping database insert')\n      return false\n    }\n\n    const { data, error } = await supabase\n      .from('products')\n      .insert(products.map(product => ({\n        ...product,\n        date_added: new Date().toISOString()\n      })))\n\n    if (error) {\n      console.error('❌ Supabase insert error:', error)\n      return false\n    }\n\n    console.log(`✅ Inserted ${products.length} products to Supabase`)\n    return true\n  } catch (error) {\n    console.error('❌ Supabase error:', error)\n    return false\n  }\n}\n\nexport async function searchSupabaseProducts(query: string): Promise<SupabaseProduct[]> {\n  try {\n    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n      console.warn('⚠️ Supabase not configured, returning empty results')\n      return []\n    }\n\n    const { data, error } = await supabase\n      .from('products')\n      .select('*')\n      .or(`name.ilike.%${query}%,category.ilike.%${query}%,brand.ilike.%${query}%,description.ilike.%${query}%`)\n      .limit(20)\n\n    if (error) {\n      console.error('❌ Supabase search error:', error)\n      return []\n    }\n\n    console.log(`🔍 Found ${data?.length || 0} products in Supabase`)\n    return data || []\n  } catch (error) {\n    console.error('❌ Supabase search error:', error)\n    return []\n  }\n}\n\nexport async function getAllSupabaseProducts(): Promise<SupabaseProduct[]> {\n  try {\n    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {\n      console.warn('⚠️ Supabase not configured, returning empty results')\n      return []\n    }\n\n    const { data, error } = await supabase\n      .from('products')\n      .select('*')\n      .limit(100)\n\n    if (error) {\n      console.error('❌ Supabase fetch error:', error)\n      return []\n    }\n\n    console.log(`📊 Loaded ${data?.length || 0} products from Supabase`)\n    return data || []\n  } catch (error) {\n    console.error('❌ Supabase fetch error:', error)\n    return []\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;AAEA,MAAM,eAAe,QAAQ,GAAG,CAAC,wBAAwB,IAAI,QAAQ,GAAG,CAAC,sBAAsB;AAC/F,MAAM,oBAAoB,QAAQ,GAAG,CAAC,6BAA6B,IAAI,QAAQ,GAAG,CAAC,sBAAsB;AAEzG,IAAI,CAAC,gBAAgB,CAAC,mBAAmB;IACvC,QAAQ,IAAI,CAAC;AACf;AAEO,MAAM,WAAW,IAAA,yMAAY,EAAC,gBAAgB,IAAI,qBAAqB;AAqBvE,eAAe,yBAAyB,QAA2B;IACxE,IAAI;QACF,IAAI,CAAC,gBAAgB,CAAC,mBAAmB;YACvC,QAAQ,IAAI,CAAC;YACb,OAAO;QACT;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,SAAS,GAAG,CAAC,CAAA,UAAW,CAAC;gBAC/B,GAAG,OAAO;gBACV,YAAY,IAAI,OAAO,WAAW;YACpC,CAAC;QAEH,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,OAAO;QACT;QAEA,QAAQ,GAAG,CAAC,CAAC,WAAW,EAAE,SAAS,MAAM,CAAC,qBAAqB,CAAC;QAChE,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO;IACT;AACF;AAEO,eAAe,uBAAuB,KAAa;IACxD,IAAI;QACF,IAAI,CAAC,gBAAgB,CAAC,mBAAmB;YACvC,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,CAAC,YAAY,EAAE,MAAM,kBAAkB,EAAE,MAAM,eAAe,EAAE,MAAM,qBAAqB,EAAE,MAAM,CAAC,CAAC,EACxG,KAAK,CAAC;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,OAAO,EAAE;QACX;QAEA,QAAQ,GAAG,CAAC,CAAC,SAAS,EAAE,MAAM,UAAU,EAAE,qBAAqB,CAAC;QAChE,OAAO,QAAQ,EAAE;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,EAAE;IACX;AACF;AAEO,eAAe;IACpB,IAAI;QACF,IAAI,CAAC,gBAAgB,CAAC,mBAAmB;YACvC,QAAQ,IAAI,CAAC;YACb,OAAO,EAAE;QACX;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,KACP,KAAK,CAAC;QAET,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,2BAA2B;YACzC,OAAO,EAAE;QACX;QAEA,QAAQ,GAAG,CAAC,CAAC,UAAU,EAAE,MAAM,UAAU,EAAE,uBAAuB,CAAC;QACnE,OAAO,QAAQ,EAAE;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 539, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/lib/optimized-chat-flow.ts"],"sourcesContent":["import { generateGeminiResponse, generateProductAnalysis } from './gemini'\nimport { fetchSerpApiProducts } from './serpapi'\nimport { parseCSVProducts, searchCSVProducts, CSVProduct } from './csv-parser'\nimport { insertProductsToSupabase, SupabaseProduct } from './supabase'\nimport { SerpApiProduct } from './serpapi'\n\ninterface ChatFlowResult {\n  response: string\n  products?: Array<{\n    name: string\n    price: number\n    platform: string\n    url: string\n    image?: string\n    rating?: number\n    reviews?: number\n    savings?: number\n  }>\n  sessionId: string\n  timestamp: string\n}\n\nexport async function processOptimizedChatFlow(\n  userMessage: string, \n  sessionId: string\n): Promise<ChatFlowResult> {\n  console.log(`🚀 Starting AI agent workflow: User → Gemini → CSV/Supabase → SerpApi`)\n  console.log(`📝 User message: \"${userMessage}\"`)\n\n  try {\n    // Step 1: Check if this is a product search query\n    const searchKeywords = ['find', 'search', 'look for', 'show me', 'recommend', 'best', 'cheap', 'deal', 'buy', 'compare', 'price']\n    const isProductSearch = searchKeywords.some(keyword => \n      userMessage.toLowerCase().includes(keyword)\n    )\n\n    if (!isProductSearch) {\n      // General conversation - just return Gemini response\n      console.log(`💬 General conversation, returning Gemini response`)\n      const geminiResponse = await generateGeminiResponse(userMessage)\n      return {\n        response: geminiResponse,\n        sessionId,\n        timestamp: new Date().toISOString()\n      }\n    }\n\n    console.log(`🔍 Detected product search query`)\n    \n    // Step 2: Extract product query\n    const productQuery = extractProductQuery(userMessage)\n    console.log(`🔍 Product query: \"${productQuery}\"`)\n    \n    // Step 3: Load local product data from CSV\n    console.log(`📁 Step 1: Loading local product data from CSV...`)\n    const csvProducts = parseCSVProducts()\n    console.log(`📊 Loaded ${csvProducts.length} products from CSV`)\n    \n    // Step 4: Search local CSV data first\n    console.log(`🔍 Step 2: Searching local CSV data...`)\n    const localResults = searchCSVProducts(productQuery, csvProducts)\n    console.log(`📦 Found ${localResults.length} relevant local products`)\n    \n    let allProducts: Array<CSVProduct | SerpApiProduct> = []\n    let dataSource = 'local'\n    \n    if (localResults.length > 0) {\n      // Step 5: We have local results - compare with SerpApi for live offers\n      console.log(`🌐 Step 3: Comparing with live SerpApi offers...`)\n      const serpApiResults = await fetchMultiSourceProducts(productQuery)\n      console.log(`🌐 Fetched ${serpApiResults.length} live offers from SerpApi`)\n      \n      // Combine and rank all results\n      allProducts = [...localResults, ...serpApiResults]\n      dataSource = 'local+live'\n    } else {\n      // Step 6: No local results - fetch fresh from SerpApi\n      console.log(`🌐 Step 3: No local results, fetching fresh offers from SerpApi...`)\n      const serpApiResults = await fetchMultiSourceProducts(productQuery)\n      console.log(`🌐 Fetched ${serpApiResults.length} fresh offers from SerpApi`)\n      \n      if (serpApiResults.length > 0) {\n        // Step 7: Insert new results into Supabase for caching\n        console.log(`💾 Step 4: Caching new results in Supabase...`)\n        const supabaseProducts: SupabaseProduct[] = serpApiResults.map(product => ({\n          name: product.name,\n          category: 'Electronics', // Default category\n          brand: extractBrand(product.name),\n          price: product.price,\n          rating: product.rating || 0,\n          reviews_count: product.reviews || 0,\n          source: product.platform,\n          url: product.url,\n          description: product.name,\n          image_url: product.image || '',\n          date_added: new Date().toISOString(),\n          extracted_price: product.price,\n          reviews: '',\n          thumbnail: product.image || '',\n          serpapi_product_api: ''\n        }))\n        \n        await insertProductsToSupabase(supabaseProducts)\n        console.log(`✅ Cached ${supabaseProducts.length} products in Supabase`)\n      }\n      \n      allProducts = serpApiResults\n      dataSource = 'live'\n    }\n    \n    // Step 8: Rank all products by price, rating, and availability\n    console.log(`🏆 Step 5: Ranking products by price, rating, and availability...`)\n    const rankedProducts = rankAllProducts(allProducts)\n    console.log(`✅ Ranked ${rankedProducts.length} products`)\n    \n    if (rankedProducts.length > 0) {\n      // Step 9: Generate enhanced response with ranked product data\n      console.log(`🤖 Step 6: Getting enhanced Gemini response with ranked product data...`)\n      const enhancedResponse = await generateProductAnalysis(rankedProducts, userMessage, dataSource)\n      console.log(`✅ Enhanced Gemini response with ranked product data received`)\n      \n      return {\n        response: enhancedResponse,\n        products: rankedProducts.slice(0, 8).map(product => ({\n          name: product.name,\n          price: product.price,\n          platform: product.platform || product.source,\n          url: product.url,\n          image: product.image || product.image_url || product.thumbnail,\n          rating: product.rating || 0,\n          reviews: product.reviews || product.reviews_count || 0,\n          savings: calculateSavings(product),\n        })),\n        sessionId,\n        timestamp: new Date().toISOString()\n      }\n    } else {\n      console.log(`⚠️ No products found, using fallback response`)\n      const geminiResponse = await generateGeminiResponse(userMessage)\n      return {\n        response: geminiResponse,\n        sessionId,\n        timestamp: new Date().toISOString()\n      }\n    }\n  } catch (error) {\n    console.error('❌ Chat flow error:', error)\n    return {\n      response: \"I'm sorry, I'm having trouble processing your request right now. Please try again later.\",\n      sessionId,\n      timestamp: new Date().toISOString()\n    }\n  }\n}\n\n// Helper function to extract product query from user message\nfunction extractProductQuery(message: string): string {\n  const lowerMessage = message.toLowerCase()\n  \n  // Remove common question words and search terms\n  const cleanedMessage = lowerMessage\n    .replace(/\\b(find|search|look for|show me|recommend|best|cheap|deal|buy|me|compare|price)\\b/g, '')\n    .replace(/\\b(under|below|above|over)\\s+\\$\\d+/g, '') // Remove price constraints\n    .trim()\n  \n  return cleanedMessage || message\n}\n\n// Helper function to extract brand from product name\nfunction extractBrand(productName: string): string {\n  const commonBrands = ['Sony', 'Apple', 'Bose', 'JBL', 'Sennheiser', 'Beats', 'Skullcandy', 'Anker', 'COWIN', 'JLab', 'Logitech', 'Audio Technica', 'Shokz', 'Heyday', 'Insignia', 'Samsung', 'Belkin', 'Koss', 'VEATOOL', 'WIGACH', 'LXX', 'WeurGhy', 'CELL EMPIRE', 'DOGO ENTERPRISES', 'SwFoer']\n  \n  for (const brand of commonBrands) {\n    if (productName.toLowerCase().includes(brand.toLowerCase())) {\n      return brand\n    }\n  }\n  \n  return 'Unknown'\n}\n\n// Helper function to rank all products (CSV + SerpApi)\nfunction rankAllProducts(products: Array<CSVProduct | SerpApiProduct>): Array<CSVProduct | SerpApiProduct> {\n  return products.sort((a, b) => {\n    // Primary sort: by price (ascending - cheaper first)\n    const priceA = a.extracted_price || a.price || 0\n    const priceB = b.extracted_price || b.price || 0\n    \n    if (priceA !== priceB) {\n      return priceA - priceB\n    }\n    \n    // Secondary sort: by rating (descending - higher rating first)\n    const ratingA = a.rating || 0\n    const ratingB = b.rating || 0\n    \n    if (ratingA !== ratingB) {\n      return ratingB - ratingA\n    }\n    \n    // Tertiary sort: by reviews count (descending - more reviews first)\n    const reviewsA = a.reviews || a.reviews_count || 0\n    const reviewsB = b.reviews || b.reviews_count || 0\n    \n    return reviewsB - reviewsA\n  })\n}\n\n// Helper function to calculate savings\nfunction calculateSavings(_product: CSVProduct | SerpApiProduct): number {\n  // Mock savings calculation - in real implementation, this would compare with MSRP\n  return Math.random() * 50 + 10\n}\n\n// Fetch products from multiple sources\nasync function fetchMultiSourceProducts(query: string) {\n  console.log(`🔍 Fetching combined products for: ${query}`)\n  \n  try {\n    // Fetch from Google Shopping (includes multiple platforms)\n    console.log(`🌐 Fetching from Google Shopping...`)\n    const googleProducts = await fetchSerpApiProducts(query)\n    console.log(`✅ Got ${googleProducts.length} items from Google Shopping`)\n    \n    // Transform and combine results\n    const allProducts = googleProducts.map(product => {\n      // Handle price data properly\n      let productPrice = 0\n      if (product.extracted_price) {\n        productPrice = product.extracted_price\n      } else if (product.price) {\n        if (typeof product.price === 'string') {\n          productPrice = parseFloat(product.price.replace(/[^0-9.]/g, '') || '0')\n        } else {\n          productPrice = product.price\n        }\n      }\n\n      return {\n        name: product.title,\n        price: productPrice,\n        platform: product.source || 'Google Shopping',\n        url: product.link,\n        image: product.thumbnail,\n        rating: product.rating,\n        reviews: product.reviews\n      }\n    })\n\n    // Remove duplicates based on URL\n    const uniqueProducts = allProducts.filter((product, index, self) =>\n      index === self.findIndex(p => p.url === product.url)\n    )\n\n    console.log(`🧩 Unique products: ${uniqueProducts.length}`)\n    return uniqueProducts\n  } catch (error) {\n    console.error('❌ Error fetching products:', error)\n    return []\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 792, "column": 0}, "map": {"version":3,"sources":["file:///Users/yunjinxie/Desktop/website/OptiBuy/src/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { prisma } from '@/lib/prisma'\nimport { processOptimizedChatFlow } from '@/lib/optimized-chat-flow'\n\nconst chatSchema = z.object({\n  message: z.string().min(1),\n  sessionId: z.string().optional(),\n  userId: z.string().optional(),\n})\n\n// Process through optimized chat flow: User → Gemini → SerpAPI\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const validatedData = chatSchema.parse(body)\n\n    // Create or find chat session\n    let sessionId = validatedData.sessionId\n    if (!sessionId) {\n      const newSession = await prisma.chatSession.create({\n        data: {\n          userId: validatedData.userId,\n        },\n      })\n      sessionId = newSession.id\n    }\n\n    // Save user message\n    await prisma.chatMessage.create({\n      data: {\n        sessionId,\n        role: 'user',\n        content: validatedData.message,\n      },\n    })\n\n    // Process through optimized chat flow: User → Gemini → SerpAPI\n    console.log(`🚀 Starting optimized chat flow for session: ${sessionId}`)\n    \n    const chatResult = await processOptimizedChatFlow(validatedData.message, sessionId)\n\n    // Save AI response\n    await prisma.chatMessage.create({\n      data: {\n        sessionId,\n        role: 'assistant',\n        content: chatResult.response,\n      },\n    })\n\n    // Prepare response data\n    const responseData: any = {\n      sessionId: chatResult.sessionId,\n      response: chatResult.response,\n      timestamp: chatResult.timestamp,\n    }\n\n    // Add products data if available\n    if (chatResult.products && chatResult.products.length > 0) {\n      responseData.products = chatResult.products\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: responseData,\n    })\n  } catch (error) {\n    console.error('Chat API error:', error)\n    \n    if (error instanceof z.ZodError) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid request data', details: error.errors },\n        { status: 400 }\n      )\n    }\n\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const sessionId = searchParams.get('sessionId')\n\n    if (!sessionId) {\n      return NextResponse.json(\n        { success: false, error: 'Session ID is required' },\n        { status: 400 }\n      )\n    }\n\n    const messages = await prisma.chatMessage.findMany({\n      where: { sessionId },\n      orderBy: { timestamp: 'asc' },\n    })\n\n    return NextResponse.json({\n      success: true,\n      data: messages,\n    })\n  } catch (error) {\n    console.error('Chat history error:', error)\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,aAAa,qNAAC,CAAC,MAAM,CAAC;IAC1B,SAAS,qNAAC,CAAC,MAAM,GAAG,GAAG,CAAC;IACxB,WAAW,qNAAC,CAAC,MAAM,GAAG,QAAQ;IAC9B,QAAQ,qNAAC,CAAC,MAAM,GAAG,QAAQ;AAC7B;AAIO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,gBAAgB,WAAW,KAAK,CAAC;QAEvC,8BAA8B;QAC9B,IAAI,YAAY,cAAc,SAAS;QACvC,IAAI,CAAC,WAAW;YACd,MAAM,aAAa,MAAM,iKAAM,CAAC,WAAW,CAAC,MAAM,CAAC;gBACjD,MAAM;oBACJ,QAAQ,cAAc,MAAM;gBAC9B;YACF;YACA,YAAY,WAAW,EAAE;QAC3B;QAEA,oBAAoB;QACpB,MAAM,iKAAM,CAAC,WAAW,CAAC,MAAM,CAAC;YAC9B,MAAM;gBACJ;gBACA,MAAM;gBACN,SAAS,cAAc,OAAO;YAChC;QACF;QAEA,+DAA+D;QAC/D,QAAQ,GAAG,CAAC,CAAC,6CAA6C,EAAE,WAAW;QAEvE,MAAM,aAAa,MAAM,IAAA,sMAAwB,EAAC,cAAc,OAAO,EAAE;QAEzE,mBAAmB;QACnB,MAAM,iKAAM,CAAC,WAAW,CAAC,MAAM,CAAC;YAC9B,MAAM;gBACJ;gBACA,MAAM;gBACN,SAAS,WAAW,QAAQ;YAC9B;QACF;QAEA,wBAAwB;QACxB,MAAM,eAAoB;YACxB,WAAW,WAAW,SAAS;YAC/B,UAAU,WAAW,QAAQ;YAC7B,WAAW,WAAW,SAAS;QACjC;QAEA,iCAAiC;QACjC,IAAI,WAAW,QAAQ,IAAI,WAAW,QAAQ,CAAC,MAAM,GAAG,GAAG;YACzD,aAAa,QAAQ,GAAG,WAAW,QAAQ;QAC7C;QAEA,OAAO,iLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mBAAmB;QAEjC,IAAI,iBAAiB,qNAAC,CAAC,QAAQ,EAAE;YAC/B,OAAO,iLAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;gBAAwB,SAAS,MAAM,MAAM;YAAC,GACvE;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,iLAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAAwB,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC;QAEnC,IAAI,CAAC,WAAW;YACd,OAAO,iLAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAyB,GAClD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,WAAW,MAAM,iKAAM,CAAC,WAAW,CAAC,QAAQ,CAAC;YACjD,OAAO;gBAAE;YAAU;YACnB,SAAS;gBAAE,WAAW;YAAM;QAC9B;QAEA,OAAO,iLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;QACR;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,iLAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;QAAwB,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}